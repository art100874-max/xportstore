name: iOS CI (Briefcase)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-14

    env:
      PYTHON_VERSION: "3.11"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Install Briefcase
        run: |
          python -m pip install --upgrade pip
          python -m pip install briefcase

      # Генерация iOS-проекта (если уже сгенерирован, шаг просто ничего не ломает)
      - name: Briefcase create iOS
        run: briefcase create iOS

      - name: Briefcase build iOS (Xcode project)
        run: briefcase build iOS

      - name: Locate workspace and scheme
        id: xcode_meta
        shell: bash
        run: |
          set -euo pipefail
          # Находим первый .xcworkspace внутри build/*
          WORKSPACE_PATH="$(ls -1d build/*/Xcode/*.xcworkspace | head -n 1)"
          if [[ -z "${WORKSPACE_PATH}" ]]; then
            echo "No .xcworkspace found under build/*/Xcode" >&2
            exit 1
          fi
          echo "workspace=$WORKSPACE_PATH" >> "$GITHUB_OUTPUT"

          # Список схем (JSON) и извлечение первой доступной схемы стандартным python
          SCHEMES_JSON="$(xcodebuild -list -json -workspace "$WORKSPACE_PATH")"
          SCHEME_NAME="$(python - <<'PY'
import json, sys
data=json.load(sys.stdin)
# Схемы могут жить и на уровне проекта и на уровне workspace; пробуем оба.
sch=[]
if "workspace" in data and "schemes" in data["workspace"]:
    sch=data["workspace"]["schemes"]
elif "project" in data and "schemes" in data["project"]:
    sch=data["project"]["schemes"]
print(sch[0] if sch else "")
PY
<<<"$SCHEMES_JSON")"
          if [[ -z "${SCHEME_NAME}" ]]; then
            echo "No Xcode scheme found. Make sure the scheme is shared in Xcode." >&2
            exit 2
          fi
          echo "scheme=$SCHEME_NAME" >> "$GITHUB_OUTPUT"
          echo "Workspace: $WORKSPACE_PATH"
          echo "Scheme:    $SCHEME_NAME"

      - name: Archive (Release)
        id: archive
        run: |
          set -euo pipefail
          mkdir -p output
          ARCHIVE_PATH="$PWD/output/App.xcarchive"
          xcodebuild \
            -workspace "${{ steps.xcode_meta.outputs.workspace }}" \
            -scheme "${{ steps.xcode_meta.outputs.scheme }}" \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath "$ARCHIVE_PATH" \
            clean archive
          echo "archive_path=$ARCHIVE_PATH" >> "$GITHUB_OUTPUT"

      # Экспорт .ipa ИДЁТ ТОЛЬКО если настроены секреты кода-подписания.
      # Иначе шаг пропускается, и вы получите .xcarchive как артефакт.
      - name: Prepare ExportOptions.plist
        if: ${{ secrets.IOS_EXPORT_METHOD != '' }}
        run: |
          cat > ExportOptions.plist <<'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>${IOS_EXPORT_METHOD}</string> <!-- development / ad-hoc / app-store -->
            <key>compileBitcode</key>
            <false/>
            <key>destination</key>
            <string>export</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>stripSwiftSymbols</key>
            <true/>
          </dict>
          </plist>
          PLIST

      - name: Export IPA
        if: ${{ secrets.IOS_EXPORT_METHOD != '' }}
        env:
          IOS_EXPORT_METHOD: ${{ secrets.IOS_EXPORT_METHOD }}
        run: |
          set -euo pipefail
          mkdir -p output/ipa
          xcodebuild -exportArchive \
            -archivePath "${{ steps.archive.outputs.archive_path }}" \
            -exportPath "output/ipa" \
            -exportOptionsPlist "ExportOptions.plist" \
            -allowProvisioningUpdates

      - name: Upload .xcarchive
        uses: actions/upload-artifact@v4
        with:
          name: ios-archive
          path: output/App.xcarchive

      - name: Upload .ipa (if exists)
        if: ${{ secrets.IOS_EXPORT_METHOD != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: output/ipa/*.ipa
