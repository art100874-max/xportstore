name: iOS CI (Briefcase)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-14

    env:
      PYTHON_VERSION: "3.11"
      IOS_EXPORT_METHOD: ${{ secrets.IOS_EXPORT_METHOD }}
      HAS_IOS_EXPORT_METHOD: ${{ secrets.IOS_EXPORT_METHOD && 'true' || 'false' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Install Briefcase
        run: |
          python -m pip install --upgrade pip
          python -m pip install briefcase

      - name: Briefcase create iOS
        run: briefcase create iOS

      - name: Briefcase build iOS (Xcode project)
        run: briefcase build iOS

      # === Detect Xcode project/workspace and scheme (robust) ===
      - name: Locate project/workspace and scheme
        id: xcode_meta
        shell: bash
        run: |
          set -euo pipefail

          echo "Searching for Xcode project/workspace under ./build ..."
          WORKSPACE_PATH="$(find build -type d -iname '*.xcworkspace' -not -path '*/DerivedData/*' -not -path '*/XCBuildData/*' | head -n 1 || true)"
          PROJECT_PATH="$(find build -type d -iname '*.xcodeproj'   -not -path '*/DerivedData/*' -not -path '*/XCBuildData/*' | head -n 1 || true)"

          echo "Candidate workspace: ${WORKSPACE_PATH:-<none>}"
          echo "Candidate project:   ${PROJECT_PATH:-<none>}"

          if [[ -n "$WORKSPACE_PATH" ]]; then
            XCODE_FLAG="-workspace"
            XCODE_PATH="$WORKSPACE_PATH"
            XCODE_KIND="workspace"
          elif [[ -n "$PROJECT_PATH" ]]; then
            XCODE_FLAG="-project"
            XCODE_PATH="$PROJECT_PATH"
            XCODE_KIND="project"
          else
            echo "No .xcworkspace or .xcodeproj found under ./build" >&2
            echo "Directory snapshot (depth 4) for diagnostics:" >&2
            find build -maxdepth 4 -type d -print | sed 's/^/  /' >&2
            exit 1
          fi

          echo "xcode_flag=$XCODE_FLAG"   >> "$GITHUB_OUTPUT"
          echo "xcode_path=$XCODE_PATH"   >> "$GITHUB_OUTPUT"
          echo "xcode_kind=$XCODE_KIND"   >> "$GITHUB_OUTPUT"
          echo "Using $XCODE_KIND: $XCODE_PATH"

          SCHEMES_JSON="$(xcodebuild -list -json $XCODE_FLAG "$XCODE_PATH")"
          SCHEME_NAME="$(python -c 'import sys,json; d=json.load(sys.stdin); s=(d.get("workspace",{}).get("schemes") or d.get("project",{}).get("schemes") or []); print(s[0] if s else "")' <<<"$SCHEMES_JSON")"
          if [[ -z "$SCHEME_NAME" ]]; then
            echo "No Xcode scheme found. Make sure the scheme is Shared in Xcode." >&2
            echo "$SCHEMES_JSON" >&2
            exit 2
          fi

          echo "scheme=$SCHEME_NAME" >> "$GITHUB_OUTPUT"
          echo "Scheme: $SCHEME_NAME"

      # === Archive with ad-hoc signing (no certs/profiles needed) ===
      - name: Archive (Release, ad-hoc)
        id: archive
        run: |
          set -euo pipefail
          mkdir -p output logs
          ARCHIVE_PATH="$PWD/output/App.xcarchive"

          xcodebuild \
            ${{ steps.xcode_meta.outputs.xcode_flag }} "${{ steps.xcode_meta.outputs.xcode_path }}" \
            -scheme "${{ steps.xcode_meta.outputs.scheme }}" \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath "$ARCHIVE_PATH" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="-" \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            CODE_SIGNING_ALLOWED=YES \
            CODE_SIGNING_REQUIRED=NO \
            PROVISIONING_PROFILE_SPECIFIER="" \
            OTHER_CODE_SIGN_FLAGS="--timestamp=none" \
            clean archive | tee logs/xcodebuild-archive.log

          echo "archive_path=$ARCHIVE_PATH" >> "$GITHUB_OUTPUT"

      - name: Upload xcodebuild log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xcodebuild-archive-log
          path: logs/xcodebuild-archive.log
          if-no-files-found: warn

      # ==== Optional IPA export (only if signing secrets configured) ====
      - name: Prepare ExportOptions.plist
        if: ${{ env.HAS_IOS_EXPORT_METHOD == 'true' }}
        run: |
          cat > ExportOptions.plist <<'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>${IOS_EXPORT_METHOD}</string> <!-- development / ad-hoc / app-store -->
            <key>compileBitcode</key>
            <false/>
            <key>destination</key>
            <string>export</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>stripSwiftSymbols</key>
            <true/>
          </dict>
          </plist>
          PLIST

      - name: Export IPA
        if: ${{ env.HAS_IOS_EXPORT_METHOD == 'true' }}
        run: |
          set -euo pipefail
          mkdir -p output/ipa
          xcodebuild -exportArchive \
            -archivePath "${{ steps.archive.outputs.archive_path }}" \
            -exportPath "output/ipa" \
            -exportOptionsPlist "ExportOptions.plist" \
            -allowProvisioningUpdates

      - name: Upload .xcarchive
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: ios-archive
          path: output/App.xcarchive

      - name: Upload .ipa (if exists)
        if: ${{ env.HAS_IOS_EXPORT_METHOD == 'true' && success() }}
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: output/ipa/*.ipa
