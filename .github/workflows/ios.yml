name: Build iOS IPA (XPort Store)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Briefcase
        run: |
          python -m pip install --upgrade pip
          pip install briefcase

      - name: Create iOS project (Briefcase)
        run: briefcase create iOS

      - name: Build iOS for simulator (Briefcase)
        run: briefcase build iOS

      - name: Debug â€” list build tree
        run: ls -R build || true

      - name: Pack unsigned IPA from simulator .app
        shell: bash
        run: |
          set -e
          APP_NAME="$(ls -1 build | head -n 1)"
          SIM_APP_DIR="$PWD/build/${APP_NAME}/ios/build/Debug-iphonesimulator"
          if [ ! -d "$SIM_APP_DIR" ]; then
            echo "Simulator build dir not found: $SIM_APP_DIR"
            exit 1
          fi
          APP_PATH="$(ls -1 "$SIM_APP_DIR"/*.app | head -n 1)"
          echo "Using app: $APP_PATH"

          EXPORT_DIR="$PWD/build/${APP_NAME}/ios/export"
          mkdir -p "$EXPORT_DIR/Payload"
          cp -R "$APP_PATH" "$EXPORT_DIR/Payload/"
          cd "$EXPORT_DIR"
          /usr/bin/zip -r "${APP_NAME}-unsigned.ipa" Payload

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: XPortStore-unsigned
          path: build/*/ios/export/*.ipa
