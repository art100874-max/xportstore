name: Build iOS IPA (XPort Store)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Briefcase
        run: |
          python -m pip install --upgrade pip
          pip install briefcase

      - name: Create iOS project (Briefcase)
        run: briefcase create iOS

      - name: Build iOS project (Briefcase)
        run: briefcase build iOS

      # --- Найти workspace/project и первую доступную схему ---
      - name: Detect workspace/project and scheme
        id: detect
        shell: bash
        run: |
          set -e
          WS="$(find build -maxdepth 12 -name '*.xcworkspace' | head -n 1 || true)"
          PRJ="$(find build -maxdepth 12 -name '*.xcodeproj'   | head -n 1 || true)"

          if [ -n "$WS" ]; then
            echo "workspace=$WS" >> $GITHUB_OUTPUT
            echo "Found workspace: $WS"
            echo "== Schemes in workspace =="
            xcodebuild -list -json -workspace "$WS" | tee list.json
            SCHEME="$(python3 - <<'PY'
import json
print(json.load(open("list.json")).get("workspace",{}).get("schemes",[""])[0])
PY
)"
          elif [ -n "$PRJ" ]; then
            echo "project=$PRJ" >> $GITHUB_OUTPUT
            echo "Found project: $PRJ"
            echo "== Schemes in project =="
            xcodebuild -list -json -project "$PRJ" | tee list.json
            SCHEME="$(python3 - <<'PY'
import json
print(json.load(open("list.json")).get("project",{}).get("schemes",[""])[0])
PY
)"
          else
            echo "No .xcworkspace or .xcodeproj found"; exit 1
          fi

          if [ -z "$SCHEME" ]; then
            echo "No schemes found"; exit 1
          fi
          echo "scheme=$SCHEME" >> $GITHUB_OUTPUT
          echo "Using SCHEME: $SCHEME"

      - name: Build for iOS Simulator via xcodebuild
        shell: bash
        run: |
          set -e
          SCHEME="${{ steps.detect.outputs.scheme }}"
          WS="${{ steps.detect.outputs.workspace }}"
          PRJ="${{ steps.detect.outputs.project }}"
          echo "SCHEME=${SCHEME}"
          if [ -n "$WS" ]; then
            xcodebuild -workspace "$WS" -scheme "$SCHEME" -configuration Debug -sdk iphonesimulator -destination "generic/platform=iOS Simulator" build
          else
            xcodebuild -project  "$PRJ" -scheme "$SCHEME" -configuration Debug -sdk iphonesimulator -destination "generic/platform=iOS Simulator" build
          fi

      - name: Debug — locate built .app
        shell: bash
        run: |
          echo "== All .app found =="
          find build -maxdepth 20 -type d -name "*.app" -print || true

      - name: Pack unsigned IPA (auto-detect .app)
        shell: bash
        run: |
          set -e
          APP_DIR="$(find build -maxdepth 20 -type d -name '*.app' | head -n 1 || true)"
          if [ -z "$APP_DIR" ]; then
            echo "No .app found under build/ after xcodebuild"; exit 1
          fi
          echo "Using app dir: $APP_DIR"
          APP_NAME="$(basename "$APP_DIR" .app)"
          EXPORT_DIR="$PWD/build/export"
          mkdir -p "$EXPORT_DIR/Payload"
          cp -R "$APP_DIR" "$EXPORT_DIR/Payload/"
          (cd "$EXPORT_DIR" && /usr/bin/zip -r "${APP_NAME}-unsigned.ipa" Payload)

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: XPortStore-unsigned
          path: build/export/*.ipa
